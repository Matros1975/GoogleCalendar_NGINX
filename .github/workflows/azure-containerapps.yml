name: CI / Build / Deploy to Azure Container Apps

on:
  push:
    # deployment branch - only deploy when commits land on this branch
    branches: [ azure-main ]
  workflow_dispatch: {}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: Servers/ElevenLabsWebhook
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        working-directory: Servers/ElevenLabsWebhook
        run: pytest -q

  build-and-deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build image and push to ACR
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          IMAGE_NAME: elevenlabs-webhook
          IMAGE_TAG: ${{ github.sha }}
        run: |
          az acr login --name $ACR_NAME
          IMAGE_FULL=${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}
          docker build -t $IMAGE_FULL Servers/ElevenLabsWebhook
          docker push $IMAGE_FULL

      - name: Deploy to Azure Container Apps
        env:
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          CONTAINERAPPS_ENV: ${{ secrets.CONTAINERAPPS_ENV }}
          CONTAINERAPP_NAME: ${{ secrets.CONTAINERAPP_NAME }}
          ACR_NAME: ${{ secrets.ACR_NAME }}
          IMAGE_NAME: elevenlabs-webhook
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_FULL=${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}

          # Create/Update container app with new image using system identity for Key Vault
          az containerapp update \
            --name $CONTAINERAPP_NAME \
            --resource-group $RESOURCE_GROUP \
            --image $IMAGE_FULL \
            || az containerapp create \
                 --name $CONTAINERAPP_NAME \
                 --resource-group $RESOURCE_GROUP \
                 --environment $CONTAINERAPPS_ENV \
                 --image $IMAGE_FULL \
                 --ingress 'external' \
                 --target-port 8000 \
                 --min-replicas 0 \
                 --max-replicas 10 \
                 --cpu 0.5 \
                 --memory 1Gi
